


import React, { useState, useEffect, useRef, useCallback } from 'react';

// Character Data (‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
const allCharactersData = {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
  // your_character_id: {
  //   id: 'your_character_id',
  //   name: "‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
  //   general: {
  //     age: null, // ‡∏≠‡∏≤‡∏¢‡∏∏
  //     height: "", // ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á
  //     build: "", // ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á
  //     skin: "", // ‡∏™‡∏µ‡∏ú‡∏¥‡∏ß
  //     hair: "", // ‡∏™‡∏µ‡∏ú‡∏°
  //     eyes: "", // ‡∏™‡∏µ‡∏ï‡∏≤
  //     nose: "", // ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏à‡∏°‡∏π‡∏Å
  //     dress: "", // ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô dressDescription ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ö dressStyle)
  //     face: "", // ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
  //     chest: "", // ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å
  //     body: "", // ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
  //     gender: "", // ‡πÄ‡∏û‡∏® (NEW)
  //     dressStyle: "", // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢ (NEW)
  //   },
  //   occupation: "", // ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
  //   catchphrase: "", // ‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ï‡∏¥‡∏î‡∏õ‡∏≤‡∏Å
  //   background: "", // ‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏•‡∏±‡∏á
  //   mbti: "", // MBTI
  //   goal: "", // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
  //   hobbies: "", // ‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å
  //   personality: "", // ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û
  //   feelings: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å
  //   values: "", // ‡∏Ñ‡πà‡∏≤‡∏ô‡∏¥‡∏¢‡∏°
  //   strengths: "", // ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á
  //   weaknesses: "", // ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô
  //   charm: "", // ‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå
  //   currentStatus: "", // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  //   thoughts: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î
  //   importantOverRules: "", // ‡∏™‡∏¥‡πà‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏é‡πÄ‡∏Å‡∏ì‡∏ë‡πå
  //   hardest: "", // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  //   management: "", // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
  //   familyStructure: "", // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
  //   imageUrl: "", // URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ placeholder ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏à‡∏£‡∏¥‡∏á)
  //   pronouns: "", // ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°
  //   speechStyle: "", // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î
  //   likes: [], // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö (‡πÄ‡∏õ‡πá‡∏ô Array)
  //   dislikes: "", // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö
  //   skills: "", // ‡∏ó‡∏±‡∏Å‡∏©‡∏∞
  //   education: "", // ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
  //   mentalState: "", // ‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡πÉ‡∏à
  //   routine: "", // ‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£
  //   emotionExpression: "", // ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå
  //   specificBehaviors: "", // ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞
  //   nameMeaning: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠
  //   role: "", // ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
  //   situations: "", // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
  //   response: "", // ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
  //   professionalContext: "", // ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
  //   family: "", // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
  //   sympathy: "", // ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à
  //   workThoughts: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô
  //   workplace: "", // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  //   workSocial: "", // ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  //   workWorries: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô
  //   childhoodDream: "", // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å
  //   whenAlone: "", // ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  //   dressStyle: "", // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢
  //   favColors: "", // ‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö
  // },
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì):
  exampleCharacter: {
    id: 'exampleCharacter',
    name: "‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
    general: {
      age: 25,
      height: "170 ‡∏ã‡∏°.",
      build: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
      skin: "‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≤‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á",
      hair: "‡∏™‡∏µ‡∏î‡∏≥",
      eyes: "‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏Ç‡πâ‡∏°",
      dress: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î ‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏¢‡∏µ‡∏ô‡∏™‡πå", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô dressDescription
      gender: "‡∏ä‡∏≤‡∏¢", // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏®
      dressStyle: "‡∏•‡∏≥‡∏•‡∏≠‡∏á", // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢
    },
    occupation: "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à",
    mbti: "ENFP",
    personality: "‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á, ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô, ‡∏ä‡∏≠‡∏ö‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢",
    imageUrl: "https://placehold.co/400x400/D1E7DD/495C52?text=‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
    speechStyle: "‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á, ‡∏°‡∏µ‡∏´‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á '‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞'",
    pronouns: "‡∏ú‡∏°/‡∏â‡∏±‡∏ô",
    likes: ["‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", "‡∏Å‡∏≤‡πÅ‡∏ü"],
  },
  anotherCharacter: {
    id: 'anotherCharacter',
    name: "‡∏≠‡∏µ‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    general: {
      age: 30,
      height: "185 ‡∏ã‡∏°.",
      build: "‡∏™‡∏π‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á",
      skin: "‡∏ú‡∏¥‡∏ß‡πÅ‡∏ó‡∏ô",
      hair: "‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏≠‡πà‡∏≠‡∏ô",
      eyes: "‡∏™‡∏µ‡∏ü‡πâ‡∏≤",
      dress: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡∏¥‡πâ‡∏ï ‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏™‡πÅ‡∏•‡∏Ñ", // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô dressDescription
      gender: "‡∏´‡∏ç‡∏¥‡∏á", // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏®
      dressStyle: "‡∏Å‡∏∂‡πà‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£", // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢
    },
    occupation: "‡∏ô‡∏±‡∏Å‡∏î‡∏ô‡∏ï‡∏£‡∏µ",
    mbti: "ISTP",
    personality: "‡∏™‡∏á‡∏ö, ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•, ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï",
    imageUrl: "https://placehold.co/400x400/C8A2C8/FFFFFF?text=‡∏≠‡∏µ‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    speechStyle: "‡∏û‡∏π‡∏î‡∏ô‡πâ‡∏≠‡∏¢, ‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤",
    pronouns: "‡πÄ‡∏Ç‡∏≤/‡πÄ‡∏ò‡∏≠",
    likes: ["‡∏î‡∏ô‡∏ï‡∏£‡∏µ", "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö"],
  }
};

// Scene Data - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏≤‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
const sceneData = {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
  // your_scene_id: { name: "‡∏ä‡∏∑‡πà‡∏≠‡∏â‡∏≤‡∏Å", color: "bg-‡∏™‡∏µ-‡∏£‡∏´‡∏±‡∏™" },
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì):
  example_scene_1: { name: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô", color: "bg-blue-100 dark:bg-blue-950" }, // Adjusted dark mode color
  example_scene_2: { name: "‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞", color: "bg-green-100 dark:bg-green-950" }, // Adjusted dark mode color
};

// Helper function to get character ID from character name (Thai name)
const getCharacterIdFromName = (name) => {
  for (const id in allCharactersData) {
    if (allCharactersData[id].name === name) {
      return id;
    }
  }
  return null; // Return null if not found
};

// Mini Character Profile Component (Pop-up) - ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
const MiniCharacterProfile = ({ character, onClose }) => {
  if (!character) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 max-w-sm w-full relative border-2 border-pink-400 dark:border-pink-600 text-gray-800 dark:text-gray-200">
        <button
          onClick={onClose}
          className="absolute top-3 right-3 bg-red-400 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg font-bold hover:bg-red-500 transition-colors duration-200 z-10"
        >
          X
        </button>

        <div className="flex flex-col items-center text-center font-mali">
          <img
            src={character.imageUrl}
            alt={`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${character.name}`}
            className="w-24 h-24 rounded-full object-cover border-2 border-purple-300 dark:border-purple-500 mb-3 shadow-md"
            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/100x100/cccccc/333333?text=‡∏£‡∏π‡∏õ"; }}
          />
          <h3 className="text-2xl font-bold text-purple-700 dark:text-purple-300 mb-2">{character.name}</h3>
          {character.general?.age && <p className="text-md text-gray-700 dark:text-gray-300"><span className="font-semibold text-purple-600 dark:text-purple-400">‡∏≠‡∏≤‡∏¢‡∏∏:</span> {character.general.age} ‡∏õ‡∏µ</p>}
          {character.occupation && <p className="text-md text-gray-700 dark:text-gray-300"><span className="font-semibold text-purple-600 dark:text-purple-400">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:</span> {character.occupation}</p>}
          {character.mbti && <p className="text-md text-gray-700 dark:text-gray-300"><span className="font-semibold text-purple-600 dark:text-purple-400">MBTI:</span> {character.mbti}</p>}
          {character.personality && (
            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2 line-clamp-3">
              <span className="font-semibold text-purple-600 dark:text-purple-400">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å:</span> {character.personality.split(';')[0]}...
            </p>
          )}
          {character.catchphrase && (
            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2 italic">
              "{character.catchphrase}"
            </p>
          )}
        </div>
      </div>
    </div>
  );
};


// Character Profile Component (Full Profile) - ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ï‡πá‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
const CharacterProfile = ({ character }) => {
  if (!character) return <p className="text-center text-red-500 dark:text-red-300">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</p>;

  // Helper function to render sections of the profile
  const renderSection = (title, content) => {
    if (!content || (typeof content === 'object' && Object.keys(content).length === 0)) return null;

    return (
      <div className="mt-4">
        <h3 className="text-xl font-semibold text-purple-600 dark:text-purple-400 mb-1">{title}:</h3>
        {typeof content === 'string' ? (
          <p className="text-gray-700 dark:text-gray-300 leading-relaxed">{content}</p>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-lg">
            {Object.entries(content).map(([key, value]) => (
              <p key={key}><span className="font-semibold text-purple-500 dark:text-purple-300 capitalize">
                {/* Translate key names to Thai for display */}
                {key === 'age' ? '‡∏≠‡∏≤‡∏¢‡∏∏' :
                 key === 'height' ? '‡∏™‡∏π‡∏á' :
                 key === 'build' ? '‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á' :
                 key === 'skin' ? '‡∏ú‡∏¥‡∏ß' :
                 key === 'hair' ? '‡∏ú‡∏°' :
                 key === 'eyes' ? '‡∏ï‡∏≤' :
                 key === 'nose' ? '‡∏à‡∏°‡∏π‡∏Å' :
                 key === 'dress' ? '‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢' : // Changed from dress to dressDescription
                 key === 'face' ? '‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤' :
                 key === 'chest' ? '‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å' :
                 key === 'body' ? '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô' :
                 key === 'gender' ? '‡πÄ‡∏û‡∏®' : // Added gender
                 key === 'dressStyle' ? '‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢' : // Added dressStyle
                 key}:
              </span> {value}</p>
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="flex flex-col md:flex-row items-center md:items-start gap-6 p-4 bg-purple-50 dark:bg-gray-700 rounded-lg shadow-inner text-gray-800 dark:text-gray-200">
      <div className="flex-shrink-0">
        <img
          src={character.imageUrl}
          alt={`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${character.name}`}
          className="w-48 h-48 md:w-64 md:h-64 rounded-full object-cover border-4 border-purple-300 dark:border-purple-500 shadow-md"
          onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x400/cccccc/333333?text=‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"; }}
        />
      </div>
      <div className="flex-grow text-center md:text-left">
        <h2 className="text-4xl font-bold text-purple-700 dark:text-purple-300 mb-2">{character.name}</h2>

        {renderSection("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", character.general)}
        {character.mbti && <p className="text-lg mb-2"><span className="font-semibold text-purple-600 dark:text-purple-400">MBTI:</span> {character.mbti}</p>}
        {character.occupation && <p className="text-lg mb-2"><span className="font-semibold text-purple-600 dark:text-purple-400">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:</span> {character.occupation}</p>}
        {character.catchphrase && <p className="text-lg mb-2"><span className="font-semibold text-purple-600 dark:text-purple-400">‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ï‡∏¥‡∏î‡∏õ‡∏≤‡∏Å:</span> "{character.catchphrase}"</p>}

        {renderSection("‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏•‡∏±‡∏á", character.background)}
        {renderSection("‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", character.goal)}
        {renderSection("‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å", character.personality)}
        {renderSection("‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à", character.hobbies)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å/‡∏à‡∏¥‡∏ï‡πÉ‡∏à", character.feelings)}
        {renderSection("‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö", character.likes)}
        {renderSection("‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö", character.dislikes)}
        {renderSection("‡∏Ñ‡πà‡∏≤‡∏ô‡∏¥‡∏¢‡∏°", character.values)}
        {renderSection("‡∏ó‡∏±‡∏Å‡∏©‡∏∞", character.skills)}
        {renderSection("‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á", character.strengths)}
        {renderSection("‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô", character.weaknesses)}
        {renderSection("‡πÄ‡∏™‡∏ô‡πà‡∏´‡πå", character.charm)}
        {renderSection("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", character.currentStatus)}
        {renderSection("‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", character.mostImportant)}
        {renderSection("‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î", character.hardest)}
        {renderSection("‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡πÉ‡∏à", character.mentalState)}
        {renderSection("‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£/‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å", character.routine)}
        {renderSection("‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå", character.emotionExpression)}
        {renderSection("‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î", character.speechStyle)}
        {renderSection("‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°", character.pronouns)}
        {renderSection("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", character.familyStructure)}
        {renderSection("‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", character.education)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô", character.complexity)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å", character.childhoodDream)}
        {renderSection("‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß", character.whenAlone)}
        {renderSection("‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢", character.dressStyle)}
        {renderSection("‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö", character.favColors)}
        {renderSection("‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞", character.specificBehaviors)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠", character.nameMeaning)}
        {renderSection("‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", character.role)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î", character.thoughts)}
        {renderSection("‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏é", character.importantOverRules)}
        {renderSection("‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", character.management)}
        {renderSection("‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå", character.situations)}
        {renderSection("‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á", character.response)}
        {renderSection("‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", character.professionalContext)}
        {renderSection("‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", character.family)}
        {renderSection("‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à", character.sympathy)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô", character.workThoughts)}
        {renderSection("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", character.workplace)}
        {renderSection("‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", character.workSocial)}
        {renderSection("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô", character.workWorries)}
      </div>
    </div>
  );
};

// Relationship Chart Component - ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
const RelationshipChart = ({ onCharacterClick }) => {
  // Character data for the chart (only necessary fields) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á
  const chartCharacters = [
    // { id: 'your_character_id_1', name: allCharactersData.your_character_id_1.name, emoji: '‚ú®', color: 'bg-yellow-200', borderColor: 'border-yellow-400' },
    // { id: 'your_character_id_2', name: allCharactersData.your_character_id_2.name, emoji: 'üåü', color: 'bg-indigo-200', borderColor: 'border-indigo-400' },
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì):
    { id: 'exampleCharacter', name: allCharactersData.exampleCharacter.name, emoji: '‚ú®', color: 'bg-yellow-200 dark:bg-yellow-800', borderColor: 'border-yellow-400 dark:border-yellow-600' },
    { id: 'anotherCharacter', name: allCharactersData.anotherCharacter.name, emoji: 'üåü', color: 'bg-indigo-200 dark:bg-indigo-800', borderColor: 'border-indigo-400 dark:border-indigo-600' },
  ];

  // Relationship data between characters - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const relationshipsData = [
    // { from: 'your_character_id_1', to: 'your_character_id_2', type: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó', icon: 'ü§ù', color: 'text-blue-500' },
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì):
    { from: 'exampleCharacter', to: 'anotherCharacter', type: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô', icon: 'üë•', color: 'text-blue-500 dark:text-blue-300' },
  ];

  // Function to find character data from ID
  const getChartCharacter = (id) => chartCharacters.find(char => char.id === id);

  // Function to get relationships for a given character
  const getRelationshipsForCharacter = (charId) => {
    return relationshipsData.filter(rel =>
      rel.from === charId || rel.to === charId
    )
    .map(rel => {
      const otherCharId = rel.from === charId ? rel.to : rel.from;
      const otherChar = allCharactersData[otherCharId];

      return {
        otherCharName: otherChar ? otherChar.name : 'Unknown',
        type: rel.type,
        icon: rel.icon,
        color: rel.color,
      };
    });
  };

  // Character card component for the chart
  const CharacterCard = ({ charId, onClick }) => {
    const char = getChartCharacter(charId);
    const fullCharData = allCharactersData[charId];

    if (!char || !fullCharData) return null;

    const relationships = getRelationshipsForCharacter(charId);

    return (
      <div
        className={`flex flex-col items-center p-4 rounded-xl ${char.color} border-2 ${char.borderColor} shadow-md cursor-pointer transform transition duration-200 hover:scale-105 text-gray-800 dark:text-gray-200`}
        onClick={() => onClick(char.id)}
      >
        <span className="text-4xl mb-2">{char.emoji}</span>
        <h4 className="font-bold text-lg text-gray-800 dark:text-gray-200 text-center">{fullCharData.name}</h4>
        {relationships.length > 0 && (
          <div className="mt-2 text-sm w-full text-center">
            {relationships.map((r, idx) => (
              <p key={idx} className={`flex items-center justify-center ${r.color}`}>
                <span className="mr-1">{r.icon}</span> {r.type} ‡∏Å‡∏±‡∏ö {r.otherCharName}
              </p>
            ))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="p-4 bg-pink-50 dark:bg-gray-700 rounded-lg shadow-inner text-gray-800 dark:text-gray-200">
      <h2 className="text-3xl font-bold text-pink-700 dark:text-pink-300 text-center mb-6">‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h2>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 justify-items-center">
        {chartCharacters.map(char => (
          <CharacterCard key={char.id} charId={char.id} onClick={onCharacterClick} />
        ))}
      </div>

      <p className="text-center text-sm text-gray-500 dark:text-gray-400 mt-4">
        * ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏¢‡πà‡∏≠
      </p>
    </div>
  );
};

// ConfirmationModal Component - Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
const ConfirmationModal = ({ message, onConfirm, onCancel }) => {
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 max-w-sm w-full text-center text-gray-800 dark:text-gray-200">
                <p className="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">{message}</p>
                <div className="flex justify-center gap-4">
                    <button
                        onClick={onConfirm}
                        className="px-5 py-2 rounded-full bg-red-500 text-white font-semibold hover:bg-red-600 transition-colors duration-200"
                    >
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button
                        onClick={onCancel}
                        className="px-5 py-2 rounded-full bg-gray-300 text-gray-800 dark:bg-gray-600 dark:text-gray-200 font-semibold hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-200"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    );
};

// ChatDisplayModal Component - Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
const ChatDisplayModal = ({ chatHistory, allCharactersData, onClose }) => {
  const formatChatMessage = (message) => {
    const senderName = message.role === 'user'
      ? (message.senderId === 'scene' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå' : allCharactersData[message.senderId]?.name)
      : message.characterName;

    const content = message.stickerUrl
      ? `[‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå: ${message.emotionTag}]` // Display sticker as text tag
      : message.text;

    return `${senderName}: ${content}`;
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 max-w-xl w-full h-3/4 flex flex-col relative border-2 border-blue-400 dark:border-blue-600 text-gray-800 dark:text-gray-200">
        <h3 className="text-2xl font-bold text-blue-700 dark:text-blue-300 mb-4 text-center">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h3>
        <textarea
          readOnly
          className="flex-1 w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg resize-none text-gray-800 dark:text-gray-200 leading-relaxed font-mono bg-gray-50 dark:bg-gray-700"
          value={chatHistory.map(formatChatMessage).join('\n')}
        />
        <button
          onClick={onClose}
          className="mt-4 px-6 py-3 rounded-full bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors duration-200 self-center"
        >
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </div>
  );
};


// Group Chat Component - ‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡πÄ‡∏ô‡∏ô‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
const GroupChat = ({ allCharactersData, setGroupChatUserRole, groupChatUserRole, activeGroupChatCharacters, handleCharacterToggle, selectedGroupCharacters, groupChatScene, setGroupChatScene, allGroupChatCharacters, chatHistory, setChatHistory }) => {
  const [userInput, setUserInput] = useState(''); // User input text
  const [isLoading, setIsLoading] = useState(false); // Loading status
  const chatEndRef = useRef(null); // Ref for scrolling to the latest message

  // New states for deletion mode
  const [isDeleteMode, setIsDeleteMode] = useState(false);
  const [selectedMessagesToDelete, setSelectedMessagesToDelete] = useState([]);
  const [showConfirmDeleteModal, setShowConfirmDeleteModal] = useState(false);
  const [showChatDisplayModal, setShowChatDisplayModal] = useState(false); // State for chat display modal


  // Sticker URLs with emotion tags
  const stickerUrls = [
    { url: "https://i.postimg.cc/05JGt6X1/1752154221215.png", emotion: "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ" },
    { url: "https://i.postimg.cc/wT8Xn6ny/1752154236841.png", emotion: "‡πÇ‡∏°‡πÇ‡∏´" },
    { url: "https://i.postimg.cc/y87FYL17/1752154251495.png", emotion: "‡∏õ‡∏£‡∏∞‡∏´‡∏•‡∏≤‡∏î‡πÉ‡∏à" },
    { url: "https://i.postimg.cc/Zn3r0gv5/1752154291489.png", emotion: "‡∏õ‡∏£‡∏∞‡∏´‡∏°‡πà‡∏≤" },
    { url: "https://i.postimg.cc/CxJbZb5k/1752154306022.png", emotion: "‡∏•‡∏±‡∏á‡πÄ‡∏•" },
    { url: "https://i.postimg.cc/1ztwD4VT/1752154320024.png", emotion: "‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à" },
    { url: "https://i.postimg.cc/50QzkG3S/1752154592685.png", emotion: "‡∏´‡∏¥‡∏ß" },
    { url: "https://i.postimg.cc/q75nw087/1752154623136.png", emotion: "‡∏á‡∏≠‡∏ô" },
    { url: "https://i.postimg.cc/qq83p3Wt/1752154648333.png", emotion: "‡∏ã‡∏≤‡∏ö‡∏ã‡∏∂‡πâ‡∏á" },
    { url: "https://i.postimg.cc/gcRRVCrY/1752154680973.png", emotion: "‡∏á‡∏±‡∏ß‡πÄ‡∏á‡∏µ‡∏¢" },
    { url: "https://i.postimg.cc/15QFJvND/1752154787497.png", emotion: "‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô" },
    { url: "https://i.postimg.cc/WbwkK0MC/1752154802978.png", emotion: "‡∏á‡πà‡∏ß‡∏á" },
    { url: "https://i.postimg.cc/0y5wqrnQ/1752154830859.png", emotion: "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢" },
    { url: "https://i.postimg.cc/HkS7WHvt/1752154856557.png", emotion: "‡πÄ‡∏ö‡∏∑‡πà‡∏≠" },
  ];

  // Quick Chat Phrases
  const quickChatPhrases = [
    '*‡∏ß‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏°‡∏≤...*',
    '*‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô...*',
    '*‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ...*',
    '*‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡πÉ‡∏à...*',
    '*‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å‡∏°‡∏∏‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á...*',
  ];

  // Situation Types for Random Situation
  const situationTypes = [
    '‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô',
    '‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢',
    '‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô',
    '‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô',
    '‡∏Å‡∏î‡∏î‡∏±‡∏ô',
    '‡∏´‡∏î‡∏´‡∏π‡πà',
    '‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏á‡∏≤',
    '‡πÄ‡∏£‡πâ‡∏≤‡πÉ‡∏à',
  ];


  // Effect for scrolling to the latest message when chatHistory changes
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatHistory]);

  // Function to clear chat history
  const handleClearChat = () => {
    setChatHistory([]);
    setSelectedMessagesToDelete([]); // Clear selections on chat clear
    setIsDeleteMode(false); // Exit delete mode
  };

  // Function to toggle delete mode
  const toggleDeleteMode = () => {
    setIsDeleteMode(prev => !prev);
    setSelectedMessagesToDelete([]); // Clear selections when entering/exiting delete mode
  };

  // Function to select/deselect a message for deletion
  const handleSelectMessageForDeletion = (index) => {
    setSelectedMessagesToDelete(prev =>
      prev.includes(index)
        ? prev.filter(i => i !== index)
        : [...prev, index]
    );
  };

  // Function to confirm deletion of selected messages
  const handleConfirmDelete = () => {
    setShowConfirmDeleteModal(true);
  };

  const confirmDeletionAction = () => {
    const sortedIndices = [...selectedMessagesToDelete].sort((a, b) => b - a); // Delete from end to avoid index issues
    let updatedChatHistory = [...chatHistory];
    sortedIndices.forEach(index => {
      updatedChatHistory.splice(index, 1);
    });
    setChatHistory(updatedChatHistory);
    setSelectedMessagesToDelete([]);
    setIsDeleteMode(false);
    setShowConfirmDeleteModal(false);
  };

  const cancelDeletionAction = () => {
    setShowConfirmDeleteModal(false);
    setSelectedMessagesToDelete([]);
    setIsDeleteMode(false);
  };

  // Function to handle sending messages in group chat
  const handleSendMessage = async () => {
    if (!userInput.trim() || activeGroupChatCharacters.length === 0) return; // Do not send if input is empty or no characters selected

    const userAsChar = groupChatUserRole === 'scene' ? null : allCharactersData[groupChatUserRole];

    const messageToSend = { role: 'user', text: userInput, senderId: groupChatUserRole };
    setChatHistory((prev) => [...prev, messageToSend]); // Add user message to history
    setUserInput(''); // Clear input field
    setIsLoading(true); // Set loading status

    // Prepare persona descriptions for all selected characters in the group
    const personasDescription = activeGroupChatCharacters.map(char =>
      `${char.name} (MBTI: ${char.mbti || 'N/A'}): ${char.personality}. Speech style: ${char.speechStyle}. Pronouns: ${char.pronouns}. Catchphrase: "${char.catchphrase || 'N/A'}"`
    ).join('\n');

    // List of available stickers and their emotions for AI
    const availableStickersForAI = stickerUrls.map(s => `[${s.emotion}]`).join(', ');

    // Create system instruction for AI to simulate group conversation
    let systemInstruction = `You are facilitating a group chat with the following characters. Each character will speak in their distinct persona and speech style. Only the characters listed below are active in this chat:\n${personasDescription}\n\n`;

    // Add instruction for AI to recognize text in asterisks as actions/scenes or stickers
    systemInstruction += `Text enclosed in asterisks (e.g., *character smiles*, *scene description*, *‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡πÉ‡∏à...*) represents an action, a scene description, or an internal thought. This is not direct dialogue.
- If it's an action or scene description, incorporate it into the narrative or your character's response. Do not directly speak the asterisked text. Respond as if you are interacting with that action or scene.
- If it's an internal thought (*‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡πÉ‡∏à...*), other characters in the chat should NOT directly acknowledge or respond to the thought itself. They should act as if they don't explicitly know the thought, but they might react to any visible actions or expressions that *might* stem from that thought. Do not explicitly state "‡∏â‡∏±‡∏ô‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡πÉ‡∏à...".
If a message contains "*‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:[emotion_tag]*", interpret it as a user sending a sticker with that emotion and acknowledge it in a natural way without repeating the asterisked text.\n\n`;
    systemInstruction += `Sometimes, one of the active characters (not the user's role-playing character) should respond by sending a sticker. To send a sticker, output "Character Name: *STICKER:[emotion_tag]*" where [emotion_tag] is one of the following emotions: ${availableStickersForAI}. Choose an emotion that fits the context of the conversation. Do not output any other text in the same line as a sticker.`;

    if (userAsChar) {
      systemInstruction += `The user is playing as ${userAsChar.name}. Their persona is: ${userAsChar.personality}. Their speech style is: ${userAsChar.speechStyle}. Their pronouns are: ${userAsChar.pronouns}. Their catchphrase is: "${userAsChar.catchphrase}".\n\n`;
      systemInstruction += `The last message was from ${userAsChar.name}. Please continue the conversation. Have 2-3 *other* characters (from the active list, not ${userAsChar.name}) respond naturally to ${userAsChar.name}'s message. Format each response as 'Character Name: message' or 'Character Name: *STICKER:[emotion_tag]*'. Ensure responses are concise and in character.`;
    } else {
      systemInstruction += `The user is setting the scene or describing actions. The last message was from the scene setter. Please continue the conversation. Have 2-3 active characters respond naturally to the scene/action. Format each response as 'Character Name: message' or 'Character Name: *STICKER:[emotion_tag]*'. Ensure responses are concise and in character.`;
    }

    // Prepare contents for Gemini API call, including system instruction and chat history
    let apiChatContents = [
      { role: "user", parts: [{ text: systemInstruction }] }
    ];

    // Add previous chat history
    chatHistory.forEach(msg => {
      if (msg.role === 'user') {
        const senderName = msg.senderId === 'scene' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå' : allCharactersData[msg.senderId]?.name;
        apiChatContents.push({
          role: 'user',
          parts: [{ text: `${senderName}: ${msg.stickerUrl ? `*‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:[${msg.emotionTag}]*` : msg.text}` }] // Send sticker as special text to AI
        });
      } else { // Message from AI
        apiChatContents.push({
          role: 'model',
          parts: [{ text: `${msg.characterName}: ${msg.stickerUrl ? `*STICKER:[${msg.emotionTag}]*` : msg.text}` }] // Send sticker as special text to AI
        });
      }
    });

    // Add the latest user message
    apiChatContents.push({
      role: "user",
      parts: [{ text: `${userAsChar ? userAsChar.name : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå'}: ${userInput}` }]
    });

    const payload = { contents: apiChatContents };
    const apiKey = ""; // API key will be provided by Canvas runtime
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const aiResponseText = result.candidates[0].content.parts[0].text;
        // Split AI response which may contain multiple character responses
        const newMessages = aiResponseText.split('\n').filter(line => line.includes(':')).map(line => {
          const [charName, ...msgParts] = line.split(':');
          const messageContent = msgParts.join(':').trim();
          const characterId = getCharacterIdFromName(charName.trim());

          // Check if the message is a sticker from AI
          const stickerMatch = messageContent.match(/^\*STICKER:\[(.*?)\]\*$/);
          if (stickerMatch) {
            const emotionTag = stickerMatch[1];
            const stickerData = stickerUrls.find(s => s.emotion === emotionTag);
            if (stickerData) {
              return { role: 'model', stickerUrl: stickerData.url, emotionTag: emotionTag, characterId: characterId, characterName: charName.trim() };
            }
          }
          return { role: 'model', text: messageContent, characterId: characterId, characterName: charName.trim() };
        });
        setChatHistory((prev) => [...prev, ...newMessages]);
      } else {
        setChatHistory((prev) => [...prev, { role: 'model', text: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ' }]);
        console.error("Unexpected API response structure:", result);
      }
    } catch (error) {
      console.error("Error calling Gemini API:", error);
      setChatHistory((prev) => [...prev, { role: 'model', text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' }]);
    } finally {
      setIsLoading(false);
    }
  };

  // Function to send a sticker
  const handleSendSticker = async (stickerData) => {
    if (activeGroupChatCharacters.length === 0) return;

    const userAsChar = groupChatUserRole === 'scene' ? null : allCharactersData[groupChatUserRole];
    const stickerMessage = {
      role: 'user',
      text: `*‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:[${stickerData.emotion}]*`, // Text sent to AI for context
      senderId: groupChatUserRole,
      stickerUrl: stickerData.url, // URL for displaying the sticker
      emotionTag: stickerData.emotion, // Store emotion tag for AI context
    };
    setChatHistory((prev) => [...prev, stickerMessage]);

    // If no other text input, send just the sticker message to AI
    if (!userInput.trim()) {
        const aiCharNames = activeGroupChatCharacters.map(char => char.name).join(', ');
        const systemInstructionForSticker = `The user has sent a sticker with the emotion "${stickerData.emotion}". Acknowledge this in a natural way. You are in a group chat with ${aiCharNames}. Sometimes, one of the active characters (not the user's role-playing character) should respond by sending a sticker. To send a sticker, output "Character Name: *STICKER:[emotion_tag]*" where [emotion_tag] is one of the following emotions: ${stickerUrls.map(s => `[${s.emotion}]`).join(', ')}. Choose an emotion that fits the context of the conversation. Do not output any other text in the same line as a sticker.`;

        let apiChatContents = [
            { role: "user", parts: [{ text: systemInstructionForSticker }] }
        ];

        chatHistory.forEach(msg => {
            if (msg.role === 'user') {
                const senderName = msg.senderId === 'scene' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå' : allCharactersData[msg.senderId]?.name;
                apiChatContents.push({
                    role: 'user',
                    parts: [{ text: `${senderName}: ${msg.stickerUrl ? `*‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:[${msg.emotionTag}]*` : msg.text}` }]
                });
            } else {
                apiChatContents.push({
                    role: 'model',
                    parts: [{ text: `${msg.characterName}: ${msg.stickerUrl ? `*STICKER:[${msg.emotionTag}]*` : msg.text}` }]
                });
            }
        });
        apiChatContents.push({
            role: "user",
            parts: [{ text: `${userAsChar ? userAsChar.name : '‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå'}: *‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå:[${stickerData.emotion}]*` }]
        });

        const payload = { contents: apiChatContents };
        const apiKey = ""; // API key will be provided by Canvas runtime
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        setIsLoading(true);
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const aiResponseText = result.candidates[0].content.parts[0].text;
                const newMessages = aiRe